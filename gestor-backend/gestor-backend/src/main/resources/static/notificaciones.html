<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Notificaciones</title>
  <link rel="stylesheet" href="css/styles.css" />
</head>
<body data-page="notificaciones" class="page">
  <aside class="sidebar">
    <div class="profile">
      <div class="avatar"></div>
      <div>
        <div style="font-weight:800" id="user-name">Usuario</div>
        <div class="small" id="user-email">email@example.com</div>
      </div>
    </div>
    <nav class="nav">
      <a href="dashboard.html">INICIO</a>
      <a href="clientes.html">AGREGAR CLIENTES</a>
      <a href="listado-clientes.html">LISTADO DE CLIENTES</a>
      <a href="datos.html">DATOS</a>
      <a href="tramites.html">TR√ÅMITES</a>
      <a href="consulta-tramites.html">CONSULTA TR√ÅMITES</a>
      <a href="tipos-tramites.html">TIPOS DE TR√ÅMITES</a>
      <a class="active" href="notificaciones.html">NOTIFICACIONES</a>
      <a href="#" class="small" onclick="logout(event)">Log out</a>
    </nav>
  </aside>

  <main class="main">
    <div class="notifications-header">
      <h2 class="section-title">Centro de Notificaciones</h2>
      <div class="notifications-actions">
        <button class="btn btn-outline" onclick="cargarNotificaciones()" title="Recargar notificaciones">üîÑ Recargar</button>
        <button class="btn btn-outline" onclick="marcarTodasLeidas()">Marcar todas como le√≠das</button>
      </div>
    </div>

    <!-- Filtros -->
    <div class="notification-filters">
      <button class="filter-btn active" data-filter="todas" onclick="filtrarPor('todas')">
        Todas (<span id="count-todas">0</span>)
      </button>
      <button class="filter-btn" data-filter="sin-leer" onclick="filtrarPor('sin-leer')">
        Sin leer (<span id="count-sin-leer">0</span>)
      </button>
      <button class="filter-btn" data-filter="tipo-ERROR" onclick="filtrarPor('tipo-ERROR')">
        Errores (<span id="count-error">0</span>)
      </button>
      <button class="filter-btn" data-filter="tipo-ADVERTENCIA" onclick="filtrarPor('tipo-ADVERTENCIA')">
        Advertencias (<span id="count-advertencia">0</span>)
      </button>
    </div>

    <!-- Lista de Notificaciones -->
    <div class="notifications-list" id="notifications-list">
      <div style="text-align:center;padding:60px;color:#999;">
        <div style="font-size:48px;margin-bottom:16px;">‚è≥</div>
        <p>Cargando notificaciones...</p>
      </div>
    </div>

    <!-- Paginaci√≥n -->
    <div class="pagination" id="pagination-controls" style="display:none;">
      <button class="btn btn-outline" id="btn-prev-page" onclick="cambiarPagina(-1)">Anterior</button>
      <span class="pagination-info" id="pagination-info">P√°gina 1 de 1</span>
      <button class="btn btn-outline" id="btn-next-page" onclick="cambiarPagina(1)">Siguiente</button>
    </div>

  </main>

  <script src="js/config.js"></script>
  <script src="js/api-service.js"></script>
  <script src="js/auth.js"></script>
  <script src="js/app.js"></script>
  <script>
    // Estado de la aplicaci√≥n
    let todasLasNotificaciones = [];
    let notificacionesFiltradas = [];
    let filtroActual = 'todas';
    let paginaActual = 0;
    let tamanioPagina = 10;
    let totalPaginas = 0;
    let usuarioActual = null;

    // Inicializar al cargar la p√°gina
    document.addEventListener('DOMContentLoaded', async function() {
      usuarioActual = obtenerUsuarioActual();
      if (!usuarioActual) {
        alert('No hay sesi√≥n activa. Redirigiendo al login...');
        window.location.href = 'index.html';
        return;
      }
      await cargarNotificaciones();
    });

    // Cargar notificaciones del backend
    async function cargarNotificaciones() {
      try {
        mostrarCargando();
        const idUsuario = usuarioActual.id || usuarioActual.idUsuario || 1;

        console.log('üîç Cargando notificaciones para usuario:', idUsuario);
        console.log('üìÑ P√°gina:', paginaActual, 'Tama√±o:', tamanioPagina);

        const response = await API.Notificaciones.obtenerPorUsuario(
          idUsuario,
          paginaActual,
          tamanioPagina
        );

        console.log('üì¶ Respuesta completa del servidor:', response);
        console.log('‚úÖ response.ok:', response.ok);
        console.log('üìä response.data:', response.data);

        if (response.ok && response.data) {
          todasLasNotificaciones = response.data.content || [];
          totalPaginas = response.data.totalPages || 1;

          console.log('üìù Total notificaciones cargadas:', todasLasNotificaciones.length);
          console.log('üìÑ Total de p√°ginas:', totalPaginas);

          aplicarFiltro(filtroActual);
          actualizarContadores();
          actualizarPaginacion();
        } else {
          console.error('‚ùå Respuesta inv√°lida:', response);
          mostrarError('No se pudieron cargar las notificaciones');
        }
      } catch (error) {
        console.error('‚ùå Error al cargar notificaciones:', error);
        console.error('Detalles del error:', error.message);
        mostrarError('Error al cargar las notificaciones: ' + error.message);
      }
    }

    // Mostrar notificaciones
    function renderizarNotificaciones(notificaciones) {
      const lista = document.getElementById('notifications-list');

      if (!notificaciones || notificaciones.length === 0) {
        lista.innerHTML = `
          <div style="text-align:center;padding:60px;color:#999;">
            <div style="font-size:48px;margin-bottom:16px;">üì≠</div>
            <p>No hay notificaciones para mostrar</p>
          </div>
        `;
        return;
      }

      lista.innerHTML = notificaciones.map(n => crearNotificacionHTML(n)).join('');
    }

    // Crear HTML de una notificaci√≥n
    function crearNotificacionHTML(notif) {
      const iconos = {
        'INFO': 'üìò',
        'ADVERTENCIA': '‚ö†Ô∏è',
        'ERROR': '‚ùå',
        'EXITO': '‚úÖ'
      };

      const clases = {
        'INFO': 'info',
        'ADVERTENCIA': 'warning',
        'ERROR': 'error',
        'EXITO': 'success'
      };

      const esNoLeida = !notif.leida;
      const fechaFormateada = formatearFecha(notif.fecha);
      const idNotif = notif.id || notif.idNotificacion; // Soportar ambos campos

      return `
        <div class="notification-item ${esNoLeida ? 'unread' : ''}" data-id="${idNotif}">
          <div class="notification-icon ${clases[notif.tipo] || 'info'}">
            ${iconos[notif.tipo] || 'üìå'}
          </div>
          <div class="notification-content">
            <div class="notification-header-row">
              <span class="notification-badge ${clases[notif.tipo] || 'info'}">${notif.tipo}</span>
              <span class="notification-time">${fechaFormateada}</span>
            </div>
            <div class="notification-message">${notif.mensaje}</div>
            <div class="notification-footer">
              ${esNoLeida ? `
                <button class="btn-link" onclick="marcarComoLeida(${idNotif})">
                  Marcar como le√≠da
                </button>
              ` : '<span style="color:#999;font-size:12px;">‚úì Le√≠da</span>'}
            </div>
          </div>
        </div>
      `;
    }

    // Formatear fecha
    function formatearFecha(fecha) {
      const date = new Date(fecha);
      const ahora = new Date();
      const diff = ahora - date;
      const minutos = Math.floor(diff / 60000);
      const horas = Math.floor(diff / 3600000);
      const dias = Math.floor(diff / 86400000);

      if (minutos < 1) return 'Justo ahora';
      if (minutos < 60) return `Hace ${minutos} min`;
      if (horas < 24) return `Hace ${horas}h`;
      if (dias < 7) return `Hace ${dias} d√≠as`;

      return date.toLocaleDateString('es-GT', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric'
      });
    }

    // Aplicar filtro
    function aplicarFiltro(filtro) {
      filtroActual = filtro;

      if (filtro === 'todas') {
        notificacionesFiltradas = [...todasLasNotificaciones];
      } else if (filtro === 'sin-leer') {
        notificacionesFiltradas = todasLasNotificaciones.filter(n => !n.leida);
      } else if (filtro.startsWith('tipo-')) {
        const tipo = filtro.replace('tipo-', '');
        notificacionesFiltradas = todasLasNotificaciones.filter(n => n.tipo === tipo);
      }

      renderizarNotificaciones(notificacionesFiltradas);
    }

    // Funci√≥n de filtrado por bot√≥n
    function filtrarPor(filtro) {
      aplicarFiltro(filtro);

      // Actualizar botones activos
      document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.classList.remove('active');
        if (btn.dataset.filter === filtro) {
          btn.classList.add('active');
        }
      });
    }

    // Actualizar contadores
    function actualizarContadores() {
      const total = todasLasNotificaciones.length;
      const sinLeer = todasLasNotificaciones.filter(n => !n.leida).length;
      const errores = todasLasNotificaciones.filter(n => n.tipo === 'ERROR').length;
      const advertencias = todasLasNotificaciones.filter(n => n.tipo === 'ADVERTENCIA').length;

      document.getElementById('count-todas').textContent = total;
      document.getElementById('count-sin-leer').textContent = sinLeer;
      document.getElementById('count-error').textContent = errores;
      document.getElementById('count-advertencia').textContent = advertencias;
    }

    // Marcar una notificaci√≥n como le√≠da
    async function marcarComoLeida(idNotificacion) {
      try {
        console.log('üìù Intentando marcar como le√≠da la notificaci√≥n:', idNotificacion);
        const response = await API.Notificaciones.marcarComoLeida(idNotificacion);
        console.log('üì¶ Respuesta de marcar como le√≠da:', response);

        if (response.ok) {
          // Actualizar en el array local (soportar ambos formatos de ID)
          const notif = todasLasNotificaciones.find(n =>
            (n.id === idNotificacion) || (n.idNotificacion === idNotificacion)
          );
          if (notif) {
            notif.leida = true;
          }

          aplicarFiltro(filtroActual);
          actualizarContadores();
          console.log('‚úÖ Notificaci√≥n marcada como le√≠da exitosamente');
        } else {
          console.error('‚ùå Respuesta no exitosa:', response);
          alert('Error: ' + (response.message || 'No se pudo marcar como le√≠da'));
        }
      } catch (error) {
        console.error('‚ùå Error al marcar como le√≠da:', error);
        console.error('Detalles completos del error:', error.message);
        alert('Error al marcar la notificaci√≥n como le√≠da: ' + error.message);
      }
    }

    // Marcar todas como le√≠das
    async function marcarTodasLeidas() {
      const noLeidas = todasLasNotificaciones.filter(n => !n.leida);

      if (noLeidas.length === 0) {
        alert('No hay notificaciones sin leer');
        return;
      }

      if (!confirm(`¬øMarcar ${noLeidas.length} notificaciones como le√≠das?`)) {
        return;
      }

      try {
        // Marcar todas secuencialmente
        for (const notif of noLeidas) {
          await API.Notificaciones.marcarComoLeida(notif.idNotificacion);
          notif.leida = true;
        }

        aplicarFiltro(filtroActual);
        actualizarContadores();
        alert('Todas las notificaciones han sido marcadas como le√≠das');
      } catch (error) {
        console.error('Error al marcar todas como le√≠das:', error);
        alert('Error al marcar las notificaciones como le√≠das');
      }
    }

    // Paginaci√≥n
    function cambiarPagina(direccion) {
      const nuevaPagina = paginaActual + direccion;

      if (nuevaPagina < 0 || nuevaPagina >= totalPaginas) {
        return;
      }

      paginaActual = nuevaPagina;
      cargarNotificaciones();
    }

    function actualizarPaginacion() {
      const controles = document.getElementById('pagination-controls');
      const info = document.getElementById('pagination-info');
      const btnPrev = document.getElementById('btn-prev-page');
      const btnNext = document.getElementById('btn-next-page');

      if (totalPaginas <= 1) {
        controles.style.display = 'none';
        return;
      }

      controles.style.display = 'flex';
      info.textContent = `P√°gina ${paginaActual + 1} de ${totalPaginas}`;
      btnPrev.disabled = paginaActual === 0;
      btnNext.disabled = paginaActual >= totalPaginas - 1;
    }

    // Funci√≥n de filtrado avanzado (modal o dropdown)
    function filtrarNotificaciones() {
      // Mostrar modal o dropdown con opciones avanzadas
      alert('Filtros avanzados: Puedes usar los botones de arriba para filtrar por tipo');
    }

    // Estados de carga
    function mostrarCargando() {
      document.getElementById('notifications-list').innerHTML = `
        <div style="text-align:center;padding:60px;color:#999;">
          <div style="font-size:48px;margin-bottom:16px;">‚è≥</div>
          <p>Cargando notificaciones...</p>
        </div>
      `;
    }

    function mostrarError(mensaje) {
      document.getElementById('notifications-list').innerHTML = `
        <div style="text-align:center;padding:60px;color:#999;">
          <div style="font-size:48px;margin-bottom:16px;">‚ö†Ô∏è</div>
          <p>${mensaje}</p>
          <button class="btn" onclick="cargarNotificaciones()">Reintentar</button>
        </div>
      `;
    }

  </script>
</body>
</html>
